# FPS 冷启动效应说明

## 问题现象
程序刚启动时FPS很低（10-30Hz），需要等待30秒-1分钟才能稳定在59.8-59.9Hz。

## 根本原因

### 1. 初始化延迟（0-5秒）
```
t=0s:    程序启动
t=0-1s:  机器人连接、UDP配置
t=1-2s:  相机初始化、预热30帧
t=2-3s:  遥操作器初始化
t=3-4s:  线程启动（8个daemon线程）
t=4-5s:  队列填充、同步等待
```

**影响**：前5秒几乎没有有效数据采集。

### 2. 累积平均FPS算法
```python
# 旧算法（第1200行）
start_time = time.time()  # 包含初始化时间
# ...
elapsed = current_time - start_time
fps = step_count / elapsed  # 累积平均
```

**问题**：
- 初始化的5秒被计入分母
- 需要很长时间才能"稀释"掉初始延迟
- 不能反映当前实时性能

### 3. 数学分析

假设前5秒初始化，之后稳定60Hz采集：

| 时间(s) | 采集帧数 | 累积FPS计算 | 实际FPS |
|---------|----------|-------------|---------|
| 5       | 0        | 0/5 = **0 Hz** | - |
| 10      | 300      | 300/10 = **30 Hz** | 60 Hz |
| 20      | 900      | 900/20 = **45 Hz** | 60 Hz |
| 30      | 1500     | 1500/30 = **50 Hz** | 60 Hz |
| 60      | 3300     | 3300/60 = **55 Hz** | 60 Hz |
| 120     | 6900     | 6900/120 = **57.5 Hz** | 60 Hz |
| 300     | 17700    | 17700/300 = **59 Hz** | 60 Hz |
| 600     | 35700    | 35700/600 = **59.5 Hz** | 60 Hz |

**结论**：需要运行**10分钟**才能达到59.5Hz！

### 4. 队列预热时间

各线程从启动到稳定产生数据需要时间：

```python
相机线程：
  - 启动后立即开始获取帧
  - 但前30帧用于预热（自动曝光、白平衡）
  - 稳定时间：~1-2秒

机器人线程：
  - UDP回调需要等待第一个数据包
  - 延迟：~100-500ms

遥操作线程：
  - SpaceMouse初始化
  - 延迟：~500ms-1s

同步线程：
  - 等待所有队列都有数据
  - 延迟：取决于最慢的线程（通常是相机）
```

**总预热时间**：2-5秒

## 解决方案（已实施）

### 滑动窗口FPS计算

```python
# 新算法
fps_window_size = 60  # 使用最近60帧
fps_window_times = []  # 存储时间戳

# 每帧更新
fps_window_times.append(current_time)
if len(fps_window_times) > fps_window_size:
    fps_window_times.pop(0)

# 计算FPS
window_duration = fps_window_times[-1] - fps_window_times[0]
fps_current = (len(fps_window_times) - 1) / window_duration
```

**优点**：
- ✅ **立即反映当前性能**：只看最近60帧
- ✅ **启动后1秒即可准确**：60帧@60Hz = 1秒
- ✅ **同时显示累积平均**：方便对比长期性能

### 新日志格式
```
Step 30/2000, FPS: 59.8 (avg: 25.3), 队列: {...}
                   ^^^^      ^^^^
                 实时FPS   累积平均
```

**解读**：
- `FPS: 59.8` = 当前实时采集速度（最近60帧）
- `avg: 25.3` = 从启动到现在的平均速度（包含初始化）

## 预期效果

### 修复前
```
t=5s:   FPS: 10.5 (实际60Hz，被初始化拖累)
t=10s:  FPS: 28.3 (实际60Hz，仍被拖累)
t=30s:  FPS: 48.7 (实际60Hz，缓慢接近)
t=60s:  FPS: 54.2 (实际60Hz，还在爬升)
t=120s: FPS: 57.1 (实际60Hz，终于接近了)
```

### 修复后
```
t=5s:   FPS: 58.9 (avg: 10.5) ✓ 立即准确
t=10s:  FPS: 59.7 (avg: 28.3) ✓ 立即准确
t=30s:  FPS: 59.8 (avg: 48.7) ✓ 立即准确
t=60s:  FPS: 59.9 (avg: 54.2) ✓ 立即准确
t=120s: FPS: 59.8 (avg: 57.1) ✓ 立即准确
```

## 其他冷启动优化建议

### 1. 跳过初始化时间
如果只关心稳定后的FPS：

```python
# 在 collection_loop 开头添加
warmup_steps = 60  # 跳过前60步

if step_count == warmup_steps:
    start_time = time.time()  # 重置开始时间
    step_count = 0  # 重置计数器
    logger.info("预热完成，开始正式计时")
```

### 2. 减少初始化时间

```python
# 相机预热帧数从30减到10
for _ in range(10):  # 原来是30
    pipeline.wait_for_frames(timeout_ms=3000)

# 启动等待时间从2秒减到1秒
time.sleep(1)  # 原来是2
```

**权衡**：可能影响相机稳定性。

### 3. 异步初始化

```python
# 让相机在后台预热，不阻塞主线程
def async_camera_warmup(pipeline):
    for _ in range(30):
        pipeline.wait_for_frames(timeout_ms=3000)

thread = threading.Thread(target=async_camera_warmup, args=(pipeline,))
thread.start()
# 继续初始化其他组件...
```

## 性能监控

### 判断系统是否健康

观察日志输出：

```bash
# ✓ 健康状态
FPS: 59.8 (avg: 57.2), 队列: {'robot': 15, 'camera': 2, 'teleop': 18, 'sync': 8}

# ⚠ 需要关注
FPS: 45.3 (avg: 48.1), 队列: {'robot': 0, 'camera': 0, 'teleop': 0, 'sync': 0}
# 原因：队列全空，说明生产者跟不上

# ❌ 异常状态
FPS: 15.2 (avg: 35.7), 队列: {'robot': 90, 'camera': 45, 'teleop': 90, 'sync': 0}
# 原因：同步队列空，但其他队列满 → 同步线程卡死
```

### 关键指标

| 指标 | 健康范围 | 异常阈值 |
|------|----------|----------|
| 实时FPS | 58-60 Hz | <55 Hz |
| FPS波动 | ±1 Hz | >3 Hz |
| 机器人队列 | 10-30 | <5 或 >80 |
| 相机队列 | 1-5 | 0 或 >40 |
| 遥操作队列 | 10-30 | <5 或 >80 |
| 同步队列 | 5-20 | 0 或 >50 |

## 常见问题

### Q1: 为什么不直接去掉累积平均FPS？
**A**: 保留累积平均有助于：
- 评估整体性能（包含初始化开销）
- 发现长时间运行后的性能衰减
- 对比不同运行session的总体效率

### Q2: 滑动窗口大小如何选择？
**A**: 
- **60帧** @ 60Hz = 1秒窗口（当前设置）
- 更小（30帧）：响应更快，但波动更大
- 更大（120帧）：更平滑，但响应慢

### Q3: 为什么实时FPS是59.8而不是精确60？
**A**: 见 `SYNC_TROUBLESHOOTING.md` - 这是正常的！
- 浮点精度误差
- sleep精度限制（1-15ms）
- 系统调度延迟

### Q4: 如何完全消除冷启动效应？
**A**: 不可能完全消除，但可以：
1. 使用滑动窗口FPS（已实施）✓
2. 跳过前N步计时
3. 异步初始化组件
4. 减少预热时间（谨慎）

## 总结

**59.8Hz vs 初期的30Hz**：
- ❌ 不是bug，是累积平均算法的固有问题
- ✅ 已修复：使用滑动窗口FPS
- ✅ 现在启动1秒后即可看到准确的59.8Hz
- ✅ 同时保留累积平均用于长期监控

**建议**：
- 关注 **实时FPS**（新增的第一个数字）
- 累积平均FPS仅用于参考
- 运行10分钟后，两者会趋于一致
